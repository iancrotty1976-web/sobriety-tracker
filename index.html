<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sobriety Tracker</title>
  
  <!-- PWA and Icon Links -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#4facfe"/>
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <!-- End PWA and Icon Links -->
  
  <style>
    body { font-family: system-ui, sans-serif; margin:0; background:#f2f4f8; color:#1f2937; }
    header { background: linear-gradient(135deg,#4facfe,#00f2fe); color:white; padding:28px 20px; text-align:center; }
    header h1 { margin:0 0 6px; font-size:28px; }
    .container { padding:18px; max-width:980px; margin:0 auto; }
    .cards { display:grid; gap:16px; grid-template-columns:1fr; }
    @media(min-width:700px){.cards{grid-template-columns:repeat(2,1fr);} }
    .card { background:white; border-radius:12px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    .card h3 { margin:0 0 10px; font-size:18px; }
    .stats { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
    .stat { background:#f8fafc; border-radius:10px; padding:12px; text-align:center; }
    .stat .num { font-size:22px; font-weight:700; color:#0f62fe; }
    .btn { padding:10px 14px; border:none; border-radius:8px; cursor:pointer; font-weight:600; color:white; }
    .btn-primary { background:#4facfe; }
    .btn-primary:hover { background:#3a8edb;}
    .btn-danger { background:#ef4444; }
    .btn-danger:hover { background:#dc2626; }
    .btn-sm { padding:6px 10px; font-size:12px; }
    .muted{color:#6b7280;font-size:13px;}
    textarea,input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;background:#fff;
      color:#000;font-size:16px;line-height:1.4;-webkit-text-fill-color:#000 !important;}
    .quote{background:linear-gradient(135deg,#eef2ff,#ecfeff);border:1px solid #dbeafe;border-radius:10px;padding:12px;}
    .flex { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .diary-entry { margin-bottom:12px; padding:12px; border:1px solid #e5e7eb; border-radius:8px; background:#fcfdff; }
    .diary-date { font-weight:700; color:#1f2937; }
    .diary-mood { font-style:italic; color:#6b7280; margin-left:8px; }
    .diary-note { margin-top:6px; white-space:pre-wrap; line-height:1.4; }
    .diary-history { max-height:300px; overflow-y:auto; }
    #confettiCanvas { position: fixed; inset: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 3000; display: none; }

    /* Modals */
    .modal-overlay { position:fixed; inset:0; background:#000000cc; display:none; align-items:center; justify-content:center; z-index: 4000; }
    .modal { background:white; padding:20px; border-radius:12px; max-width:420px; width:90%; }
  </style>
</head>
<body>
  <header>
    <h1>Sobriety Tracker</h1>
    <p>Focus on your streaks and savings ðŸ™Œ</p>
  </header>

  <div class="container">
    <div class="cards">

      <!-- Progress -->
      <div class="card">
        <h3>Progress</h3>
        <div class="stats">
          <div class="stat"><div class="num" id="daysSober">0</div><div class="muted">Days Sober</div></div>
          <div class="stat"><div class="num" id="currentStreak">0</div><div class="muted">Current Streak</div></div>
          <div class="stat"><div class="num" id="longestStreak">0</div><div class="muted">Longest Streak</div></div>
          <div class="stat"><div class="num" id="moneySaved">Â£0</div><div class="muted">Money Saved</div></div>
        </div>
        <div class="muted" id="spendHint" style="margin-top:8px; display:none;">
          Tip: Set your weekly spend to see accurate savings.
        </div>
      </div>

      <!-- Daily Diary -->
      <div class="card">
        <h3>Daily Diary</h3>
        <label>Date</label><input id="diaryDate" type="date"/>
        <label>Mood</label>
        <select id="diaryMood"><option>Great</option><option>Good</option><option>Okay</option><option>Meh</option><option>Struggling</option></select>
        <label>Notes</label><textarea id="diary" rows="3" placeholder="How are you feeling today? Any triggers or wins?"></textarea>
        <button id="saveDiary" class="btn btn-primary" style="margin-top:8px;">Save Entry</button>
        <div class="muted" id="diarySavedMsg"></div>
      </div>

      <!-- Diary History (Scrollable Journal) -->
      <div class="card">
        <h3>Journal History</h3>
        <div class="diary-history" id="diaryHistory">
          <div class="muted">No entries yet.</div>
        </div>
      </div>

      <!-- Relapse -->
      <div class="card">
        <h3>Relapse</h3>
        <button id="relapseBtn" class="btn btn-danger">Log a Relapse</button>
        <p class="muted">This will reset your streak but keep your diary entries.</p>
      </div>

      <!-- Daily Motivation -->
      <div class="card">
        <h3>Daily Motivation</h3>
        <div class="quote" id="quoteBox">Loading...</div>
        <div class="muted" id="quoteAttribution"></div>
      </div>

      <!-- Reminders & Settings -->
      <div class="card">
        <h3>Reminders & Settings</h3>
        <div class="flex" style="margin-bottom:8px;">
          <div class="flex"><input type="checkbox" id="reminderEnabled" /><label for="reminderEnabled">Daily reminder</label></div>
          <input type="time" id="reminderTime" />
          <button id="saveReminder" class="btn btn-primary">Save</button>
        </div>
        <div class="muted" id="reminderStatus"></div>
        
        <div style="margin-top:12px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <button id="changeSpendBtn" class="btn btn-sm btn-primary">Change Weekly Spend</button>
          <button id="reaskSetupBtn" class="btn btn-sm" style="background:#6b7280;">Ask weekly spend again</button>
          <span class="muted" id="currentSpend">Not set</span>
        </div>
        
        <div style="height:10px;"></div>
        <button id="installBtn" class="btn btn-primary" type="button" style="display:none;">ðŸ“² Install App</button>
        <button id="resetBtn" class="btn btn-danger" style="margin-left:10px;">Reset Progress</button>
        <p class="muted" style="margin-top:8px;">Note: Browser notifications only work when app is open. For background alerts, we can add Web Push later.</p>
      </div>

    </div>
  </div>

  <!-- Setup Modal -->
  <div id="setupModal" class="modal-overlay">
    <div class="modal">
      <h3>Welcome ðŸŽ‰</h3>
      <p>Let's personalise your journey.</p>
      <label>How much money do you spend per week on alcohol (on average)?</label>
      <input id="baselineSpend" type="number" placeholder="Â£ per week" />
      <div style="margin-top:10px;">
        <button id="saveSetup" class="btn btn-primary">Save & Continue</button>
        <button id="skipSetup" class="btn" style="background:#6b7280;margin-left:10px;">Skip for now</button>
      </div>
    </div>
  </div>

  <!-- Change Spend Modal -->
  <div id="changeSpendModal" class="modal-overlay">
    <div class="modal">
      <h3>Update Weekly Spend</h3>
      <label>How much money do you spend per week on alcohol (on average)?</label>
      <input id="newBaselineSpend" type="number" placeholder="Â£ per week" />
      <div style="margin-top:10px;">
        <button id="saveNewSpend" class="btn btn-primary">Update</button>
        <button id="cancelChangeSpend" class="btn" style="background:#6b7280;margin-left:10px;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Milestone Celebration Modal -->
  <div id="milestoneModal" class="modal-overlay" style="background:#000a; z-index: 4500;">
    <div class="modal" style="text-align:center; max-width:400px;">
      <h2 id="milestoneTitle">ðŸŽ‰ Congrats!</h2>
      <p id="milestoneMessage">You hit a milestone!</p>
      <button onclick="closeMilestone()" 
        style="margin-top:10px;background:#4facfe;color:white;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:600;">
        Awesome!
      </button>
    </div>
  </div>

  <!-- Confetti Canvas -->
  <canvas id="confettiCanvas"></canvas>

<script>
const ls = {
  get:(k,d=null)=>{ try{return JSON.parse(localStorage.getItem(k)) ?? d;}catch{return d;} },
  set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),
  del:(k)=>localStorage.removeItem(k)
};

// Read baselineSpend safely as a Number (NaN if missing)
let baselineSpend = Number(ls.get('baselineSpend', NaN));
if (typeof baselineSpend !== 'number' || isNaN(baselineSpend)) baselineSpend = NaN;

let firstSoberDate = ls.get('firstSoberDate',null);
let streak = Number(ls.get('streak',0)) || 0;
let longestStreak = Number(ls.get('longestStreak',0)) || 0;

// Elements
const reminderEnabledEl = document.getElementById('reminderEnabled');
const reminderTimeEl = document.getElementById('reminderTime');
const reminderStatusEl = document.getElementById('reminderStatus');
const spendHintEl = document.getElementById('spendHint');
const currentSpendEl = document.getElementById('currentSpend');

reminderEnabledEl.checked = !!ls.get('reminderEnabled', false);
reminderTimeEl.value = ls.get('reminderTime', '20:00');

// Utils
function show(el){ el.style.display='flex'; }
function hide(el){ el.style.display='none'; }

function calcDaysSober(){
  if(!firstSoberDate) return 0;
  const s=new Date(firstSoberDate), n=new Date();
  return Math.max(0,Math.floor((n-s)/(1000*60*60*24)));
}

// ðŸŽ‰ Milestone Celebration
function checkMilestones() {
  const milestones = [7, 30, 90, 180, 365];
  const days = calcDaysSober();
  if (milestones.includes(days)) {
    document.getElementById("milestoneTitle").textContent = "ðŸŽ‰ Congrats!";
    document.getElementById("milestoneMessage").textContent = `Youâ€™ve reached ${days} days sober! Keep going ðŸ’ª`;
    show(document.getElementById("milestoneModal"));
    startConfetti(250);
  }
}
function closeMilestone() {
  hide(document.getElementById('milestoneModal'));
  stopConfetti();
}

function renderStats(){
  document.getElementById('currentStreak').textContent = streak;
  document.getElementById('daysSober').textContent = calcDaysSober();
  document.getElementById('longestStreak').textContent = longestStreak;
  
  if(typeof baselineSpend === 'number' && !isNaN(baselineSpend) && baselineSpend > 0){
    const dailySpend = baselineSpend / 7;
    const daysSober = calcDaysSober();
    const saved = Math.round(dailySpend * daysSober);
    document.getElementById('moneySaved').textContent = "Â£" + saved;
    spendHintEl.style.display = 'none';
    currentSpendEl.textContent = `Currently: Â£${baselineSpend}/week`;
  } else {
    document.getElementById('moneySaved').textContent = "Â£0";
    spendHintEl.style.display = 'block';
    currentSpendEl.textContent = "Not set";
  }

  checkMilestones();
}

// daily streak increment (once per day)
(function daily(){
  const k='lastStreakDay', last=ls.get(k,null), today=new Date().toDateString();
  if(last!==today){
    streak=(streak||0)+1;
    if(!firstSoberDate) firstSoberDate=new Date().toISOString();
    ls.set('firstSoberDate',firstSoberDate);
    ls.set('streak',streak);
    if(streak>longestStreak){ longestStreak=streak; ls.set('longestStreak',streak); }
    ls.set(k,today);
  }
})();
renderStats();

// ==== Diary ====
const diaryDateEl=document.getElementById('diaryDate'),
      diaryMoodEl=document.getElementById('diaryMood'),
      diaryEl=document.getElementById('diary'),
      diaryMsgEl=document.getElementById('diarySavedMsg');
diaryDateEl.valueAsDate=new Date();

document.getElementById('saveDiary').addEventListener('click',()=>{
  const dateVal = diaryDateEl.value || new Date().toISOString().slice(0,10);
  const key='diary:'+ dateVal;
  const entry={
    date: dateVal,
    mood: diaryMoodEl.value,
    note: diaryEl.value,
    savedAt: new Date().toISOString()
  };
  ls.set(key,entry);
  diaryMsgEl.textContent='Saved âœ”';
  setTimeout(()=>diaryMsgEl.textContent='',2000);
  renderDiaryHistory();
});

// Diary History
function renderDiaryHistory(){
  const historyEl = document.getElementById('diaryHistory');
  const entries = [];
  for(let i=0; i<localStorage.length; i++){
    const k = localStorage.key(i);
    if(k && k.startsWith("diary:")) {
      try { 
        const entry = JSON.parse(localStorage.getItem(k));
        if(entry) entries.push(entry);
      } catch {}
    }
  }
  entries.sort((a,b) => new Date(b.date) - new Date(a.date));
  if(entries.length === 0){
    historyEl.innerHTML = '<div class="muted">No entries yet.</div>';
    return;
  }
  historyEl.innerHTML = entries.map(entry => `
    <div class="diary-entry">
      <div>
        <span class="diary-date">${entry.date || 'Unknown date'}</span>
        <span class="diary-mood">â€” ${entry.mood || 'No mood'}</span>
      </div>
      ${entry.note ? `<div class="diary-note">${escapeHtml(entry.note)}</div>` : '<div class="muted">No notes</div>'}
    </div>
  `).join('');
}
function escapeHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;')
    .replace(/\n/g, '<br/>');
}
renderDiaryHistory();

// ==== Relapse ====
document.getElementById('relapseBtn').addEventListener('click',()=>{
  if(confirm("Log a relapse? This will reset your streak to 0.")){
    if(streak>longestStreak){ longestStreak=streak; ls.set('longestStreak',streak);}
    streak=0; firstSoberDate=null;
    ls.set('streak',0); ls.set('firstSoberDate',null);
    renderStats();
    alert("Relapse logged. Tomorrow is a new day ðŸŒ±");
  }
});

// ==== Reset (stats only; diary preserved) ====
document.getElementById('resetBtn').addEventListener('click',()=>{
  if(confirm("Reset ALL stats (diary will remain)?")){
    streak=0; firstSoberDate=null; longestStreak=0;
    ls.set('streak',0); ls.set('firstSoberDate',null); ls.set('longestStreak',0);
    renderStats();
  }
});

// ==== Quotes ====
const QUOTES=[
  {q:"One day at a time.",a:"AA Slogan"},
  {q:"Progress, not perfection.",a:"AA Slogan"},
  {q:"You are stronger than your strongest excuse.",a:"Unknown"},
  {q:"The comeback is always stronger than the setback.",a:"Unknown"},
  {q:"Small steps every day lead to big results.",a:"Unknown"}
];
const qi=(new Date().getFullYear()*1000+(new Date().getMonth()+1)*50+new Date().getDate())%QUOTES.length;
document.getElementById('quoteBox').textContent='"'+QUOTES[qi].q+'"';
document.getElementById('quoteAttribution').textContent="â€” "+QUOTES[qi].a;

// ==== Weekly Spend Setup (auto show if not set or <= 0) ====
const setupModal = document.getElementById('setupModal');
const baselineSpendInput = document.getElementById('baselineSpend');

function openSetupModal() {
  show(setupModal);
  // Autofill current value if any
  baselineSpendInput.value = (typeof baselineSpend==='number' && !isNaN(baselineSpend) && baselineSpend>0) ? baselineSpend : '';
  setTimeout(()=>baselineSpendInput.focus(), 50);
}
function closeSetupModal() { hide(setupModal); }

if (!(typeof baselineSpend==='number' && !isNaN(baselineSpend) && baselineSpend>0)) {
  openSetupModal();
}

document.getElementById('saveSetup').addEventListener('click',()=>{
  const spend=parseFloat(baselineSpendInput.value||"");
  if(!isNaN(spend) && spend>0){
    baselineSpend = spend; 
    ls.set('baselineSpend', spend);
    closeSetupModal();
    renderStats();
  } else {
    alert("Please enter a valid amount greater than 0 (Â£ per week)");
  }
});
document.getElementById('skipSetup').addEventListener('click',()=>{
  baselineSpend = 0;
  ls.set('baselineSpend', 0);
  closeSetupModal();
  renderStats();
});

// ==== Change spend (always available) ====
const changeSpendModal = document.getElementById('changeSpendModal');
const newBaselineSpendInput = document.getElementById('newBaselineSpend');
function openChangeSpend() {
  newBaselineSpendInput.value = (typeof baselineSpend==='number' && !isNaN(baselineSpend) && baselineSpend>=0) ? baselineSpend : '';
  show(changeSpendModal);
  setTimeout(()=>newBaselineSpendInput.focus(), 50);
}
function closeChangeSpend(){ hide(changeSpendModal); }

document.getElementById('changeSpendBtn').addEventListener('click', openChangeSpend);
document.getElementById('saveNewSpend').addEventListener('click',()=>{
  const newSpend = parseFloat(newBaselineSpendInput.value||"");
  if(!isNaN(newSpend) && newSpend >= 0){
    baselineSpend = newSpend;
    ls.set('baselineSpend', newSpend);
    closeChangeSpend();
    renderStats();
  } else {
    alert("Please enter a valid amount (Â£ per week, 0 or more)");
  }
});
document.getElementById('cancelChangeSpend').addEventListener('click', closeChangeSpend);

// Re-ask initial setup on demand
document.getElementById('reaskSetupBtn').addEventListener('click', openSetupModal);

// ==== Reminders ====
function requestPermissionIfNeeded() {
  if (!('Notification' in window)) return Promise.resolve('unsupported');
  if (Notification.permission === 'granted') return Promise.resolve('granted');
  if (Notification.permission === 'denied') return Promise.resolve('denied');
  return Notification.requestPermission();
}
function fireReminder() {
  const title = 'Daily check-in';
  const body = 'How are you feeling? Log a diary entry or update your progress.';
  if ('Notification' in window && Notification.permission === 'granted') {
    try { new Notification(title, { body, icon: 'icons/icon-192.png' }); }
    catch { alert(body); }
  } else {
    alert(body);
  }
}
function scheduleTick() {
  clearInterval(window.__reminderTimer);
  if (!reminderEnabledEl.checked) {
    reminderStatusEl.textContent = 'Daily reminder is off.';
    return;
  }
  const [hh, mm] = (reminderTimeEl.value || '20:00').split(':').map(n => parseInt(n,10));
  reminderStatusEl.textContent = `Reminder set for ${hh.toString().padStart(2,'0')}:${mm.toString().padStart(2,'0')} daily.`;
  window.__reminderTimer = setInterval(() => {
    const now = new Date();
    if (now.getHours() === hh && now.getMinutes() === mm && now.getSeconds() < 5) {
      const key = 'reminderLast:' + now.toDateString();
      if (ls.get(key, null)) return; // one per day
      ls.set(key, true);
      fireReminder();
    }
  }, 1000);
}
document.getElementById('saveReminder').addEventListener('click', async () => {
  ls.set('reminderEnabled', reminderEnabledEl.checked);
  ls.set('reminderTime', reminderTimeEl.value || '20:00');
  if (reminderEnabledEl.checked) {
    const perm = await requestPermissionIfNeeded();
    if (perm !== 'granted') {
      reminderStatusEl.textContent = 'Notifications not allowed â€” using in-app alerts.';
    }
  }
  scheduleTick();
});
scheduleTick();

// ==== PWA install ====
let deferredPrompt; const installBtn=document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;installBtn.style.display="inline-block";});
installBtn.addEventListener('click',async()=>{
  if(!deferredPrompt) return alert("Tip: choose 'Install app' from your browser menu");
  deferredPrompt.prompt(); await deferredPrompt.userChoice; installBtn.style.display="none";
});

// ==== Service Worker Registration ====
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then((registration) => console.log('SW registered: ', registration))
      .catch((err) => console.log('SW registration failed: ', err));
  });
}

/* === Confetti (lightweight) === */
let confettiRunning=false, confettiRAF=null, confettiParticles=[];
const confettiCanvas=document.getElementById('confettiCanvas');
const ctx=confettiCanvas.getContext('2d');
function resizeConfetti() { confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
window.addEventListener('resize', resizeConfetti); resizeConfetti();
function randomColor() {
  const colors=['#ff4757','#ffa502','#2ed573','#1e90ff','#5352ed','#ff6b81','#70a1ff','#7bed9f'];
  return colors[Math.floor(Math.random()*colors.length)];
}
function createParticles(count=200) {
  const w=confettiCanvas.width, h=confettiCanvas.height;
  confettiParticles = Array.from({length: count}).map(()=>({
    x: Math.random()*w, y: -20 - Math.random()*h*0.5, r: 3 + Math.random()*4,
    vx: -2 + Math.random()*4, vy: 2 + Math.random()*3, rot: Math.random()*Math.PI, vr: -0.1 + Math.random()*0.2,
    color: randomColor(), shape: Math.random()<0.5 ? 'rect' : 'circle', opacity: 0.8 + Math.random()*0.2
  }));
}
function drawParticle(p) {
  ctx.save(); ctx.globalAlpha = p.opacity; ctx.translate(p.x, p.y); ctx.rotate(p.rot); ctx.fillStyle = p.color;
  if (p.shape === 'rect') { ctx.fillRect(-p.r*1.5, -p.r, p.r*3, p.r*2); } else { ctx.beginPath(); ctx.arc(0,0,p.r,0,Math.PI*2); ctx.fill(); }
  ctx.restore();
}
function updateParticles() {
  const w=confettiCanvas.width, h=confettiCanvas.height;
  for (const p of confettiParticles) {
    p.x += p.vx; p.y += p.vy; p.vy += 0.02; p.rot += p.vr;
    if (p.y > h + 30) { p.y = -20; p.x = Math.random()*w; p.vy = 2 + Math.random()*3; }
  }
}
function renderConfetti() {
  if (!confettiRunning) return;
  ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
  for (const p of confettiParticles) drawParticle(p);
  updateParticles();
  confettiRAF = requestAnimationFrame(renderConfetti);
}
function startConfetti(count=220, durationMs=3500) {
  if (confettiRunning) return;
  confettiRunning = true;
  confettiCanvas.style.display = 'block';
  createParticles(count);
  renderConfetti();
  setTimeout(stopConfetti, durationMs);
}
function stopConfetti() {
  if (!confettiRunning) return;
  confettiRunning = false;
  cancelAnimationFrame(confettiRAF);
  ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
  confettiCanvas.style.display = 'none';
}
</script>
</body>
</html>