<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sobriety Tracker</title>
  
  <!-- PWA and Icon Links -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#4facfe"/>
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <!-- End PWA and Icon Links -->
  
  <style>
    body { font-family: system-ui, sans-serif; margin:0; background:#f2f4f8; color:#1f2937; }
    header { background: linear-gradient(135deg,#4facfe,#00f2fe); color:white; padding:28px 20px; text-align:center; }
    header h1 { margin:0 0 6px; font-size:28px; }
    .container { padding:18px; max-width:980px; margin:0 auto; }
    .cards { display:grid; gap:16px; grid-template-columns:1fr; }
    @media(min-width:700px){.cards{grid-template-columns:repeat(2,1fr);} }
    .card { background:white; border-radius:12px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    .card h3 { margin:0 0 10px; font-size:18px; }
    .stats { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
    .stat { background:#f8fafc; border-radius:10px; padding:12px; text-align:center; }
    .stat .num { font-size:22px; font-weight:700; color:#0f62fe; }
    .btn { padding:10px 14px; border:none; border-radius:8px; cursor:pointer; font-weight:600; color:white; }
    .btn-primary { background:#4facfe; }
    .btn-primary:hover { background:#3a8edb;}
    .btn-danger { background:#ef4444; }
    .btn-danger:hover { background:#dc2626; }
    .btn-sm { padding:6px 10px; font-size:12px; }
    .muted{color:#6b7280;font-size:13px;}
    textarea,input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;background:#fff;
      color:#000;font-size:16px;line-height:1.4;-webkit-text-fill-color:#000 !important;}
    .quote{background:linear-gradient(135deg,#eef2ff,#ecfeff);border:1px solid #dbeafe;border-radius:10px;padding:12px;}
    .flex { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .diary-entry { margin-bottom:12px; padding:12px; border:1px solid #e5e7eb; border-radius:8px; background:#fcfdff; }
    .diary-date { font-weight:700; color:#1f2937; }
    .diary-mood { font-style:italic; color:#6b7280; margin-left:8px; }
    .diary-note { margin-top:6px; white-space:pre-wrap; line-height:1.4; }
    .diary-history { max-height:300px; overflow-y:auto; }
  </style>
</head>
<body>
  <header>
    <h1>Sobriety Tracker</h1>
    <p>Focus on your streaks and savings ðŸ™Œ</p>
  </header>

  <div class="container">
    <div class="cards">

      <!-- Progress -->
      <div class="card">
        <h3>Progress</h3>
        <div class="stats">
          <div class="stat"><div class="num" id="daysSober">0</div><div class="muted">Days Sober</div></div>
          <div class="stat"><div class="num" id="currentStreak">0</div><div class="muted">Current Streak</div></div>
          <div class="stat"><div class="num" id="longestStreak">0</div><div class="muted">Longest Streak</div></div>
          <div class="stat"><div class="num" id="moneySaved">Â£0</div><div class="muted">Money Saved</div></div>
        </div>
      </div>

      <!-- Daily Diary -->
      <div class="card">
        <h3>Daily Diary</h3>
        <label>Date</label><input id="diaryDate" type="date"/>
        <label>Mood</label>
        <select id="diaryMood"><option>Great</option><option>Good</option><option>Okay</option><option>Meh</option><option>Struggling</option></select>
        <label>Notes</label><textarea id="diary" rows="3" placeholder="How are you feeling today? Any triggers or wins?"></textarea>
        <button id="saveDiary" class="btn btn-primary" style="margin-top:8px;">Save Entry</button>
        <div class="muted" id="diarySavedMsg"></div>
      </div>

      <!-- Diary History (Scrollable Journal) -->
      <div class="card">
        <h3>Journal History</h3>
        <div class="diary-history" id="diaryHistory">
          <div class="muted">No entries yet.</div>
        </div>
      </div>

      <!-- Relapse -->
      <div class="card">
        <h3>Relapse</h3>
        <button id="relapseBtn" class="btn btn-danger">Log a Relapse</button>
        <p class="muted">This will reset your streak but keep your diary entries.</p>
      </div>

      <!-- Daily Motivation -->
      <div class="card">
        <h3>Daily Motivation</h3>
        <div class="quote" id="quoteBox">Loading...</div>
        <div class="muted" id="quoteAttribution"></div>
      </div>

      <!-- Reminders & Settings -->
      <div class="card">
        <h3>Reminders & Settings</h3>
        <div class="flex" style="margin-bottom:8px;">
          <div class="flex"><input type="checkbox" id="reminderEnabled" /><label for="reminderEnabled">Daily reminder</label></div>
          <input type="time" id="reminderTime" />
          <button id="saveReminder" class="btn btn-primary">Save</button>
        </div>
        <div class="muted" id="reminderStatus"></div>
        
        <div style="margin-top:12px;">
          <button id="changeSpendBtn" class="btn btn-sm btn-primary">Change Weekly Spend</button>
          <span class="muted" id="currentSpend">Not set</span>
        </div>
        
        <div style="height:10px;"></div>
        <button id="installBtn" class="btn btn-primary" type="button" style="display:none;">ðŸ“² Install App</button>
        <button id="resetBtn" class="btn btn-danger" style="margin-left:10px;">Reset Progress</button>
        <p class="muted" style="margin-top:8px;">Note: Browser notifications only work when app is open. For background alerts, we can add Web Push later.</p>
      </div>

    </div>
  </div>

  <!-- Setup Modal -->
  <div id="setupModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:#000000dd;display:none;align-items:center;justify-content:center;z-index:1000;">
    <div style="background:white;padding:20px;border-radius:12px;max-width:420px;width:90%;">
      <h3>Welcome ðŸŽ‰</h3>
      <p>Let's personalise your journey.</p>
      <label>How much money do you spend per week on alcohol (on average)?</label>
      <input id="baselineSpend" type="number" placeholder="Â£ per week" />
      <button id="saveSetup" class="btn btn-primary" style="margin-top:10px;">Save & Continue</button>
      <button id="skipSetup" class="btn" style="background:#6b7280;margin-top:10px;margin-left:10px;">Skip for now</button>
    </div>
  </div>

  <!-- Change Spend Modal -->
  <div id="changeSpendModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:#000000dd;display:none;align-items:center;justify-content:center;z-index:1000;">
    <div style="background:white;padding:20px;border-radius:12px;max-width:420px;width:90%;">
      <h3>Update Weekly Spend</h3>
      <label>How much money do you spend per week on alcohol (on average)?</label>
      <input id="newBaselineSpend" type="number" placeholder="Â£ per week" />
      <div style="margin-top:10px;">
        <button id="saveNewSpend" class="btn btn-primary">Update</button>
        <button id="cancelChangeSpend" class="btn" style="background:#6b7280;margin-left:10px;">Cancel</button>
      </div>
    </div>
  </div>

<script>
const ls = {
  get:(k,d=null)=>{ try{return JSON.parse(localStorage.getItem(k)) ?? d;}catch{return d;} },
  set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),
  del:(k)=>localStorage.removeItem(k)
};

let drinksThisWeek = ls.get('drinksThisWeek',0);
let firstSoberDate = ls.get('firstSoberDate',null);
let streak = ls.get('streak',0);
let longestStreak = ls.get('longestStreak',0);
let baselineSpend = ls.get('baselineSpend', null);

// Reminders state
const reminderEnabledEl = document.getElementById('reminderEnabled');
const reminderTimeEl = document.getElementById('reminderTime');
const reminderStatusEl = document.getElementById('reminderStatus');
reminderEnabledEl.checked = !!ls.get('reminderEnabled', false);
reminderTimeEl.value = ls.get('reminderTime', '20:00');

function renderStats(){
  document.getElementById('currentStreak').textContent = streak;
  document.getElementById('daysSober').textContent = calcDaysSober();
  document.getElementById('longestStreak').textContent = longestStreak;
  
  // Money saved calculation
  if(baselineSpend && baselineSpend > 0){
    const dailySpend = baselineSpend / 7;
    const daysSober = calcDaysSober();
    const saved = Math.round(dailySpend * daysSober);
    document.getElementById('moneySaved').textContent = "Â£" + saved;
  } else {
    document.getElementById('moneySaved').textContent = "Â£0";
  }
  
  // Update current spend display
  const currentSpendEl = document.getElementById('currentSpend');
  if(baselineSpend && baselineSpend > 0) {
    currentSpendEl.textContent = `Currently: Â£${baselineSpend}/week`;
  } else {
    currentSpendEl.textContent = "Not set";
  }
}

function calcDaysSober(){
  if(!firstSoberDate) return 0;
  const s=new Date(firstSoberDate), n=new Date();
  return Math.max(0,Math.floor((n-s)/(1000*60*60*24)));
}

// update daily streak (once per calendar day)
(function daily(){
  const k='lastStreakDay', last=ls.get(k,null), today=new Date().toDateString();
  if(last!==today){
    streak=(streak||0)+1;
    if(!firstSoberDate) firstSoberDate=new Date().toISOString();
    ls.set('firstSoberDate',firstSoberDate);
    ls.set('streak',streak);
    if(streak>longestStreak){ longestStreak=streak; ls.set('longestStreak',streak); }
    ls.set(k,today);
  }
})();
renderStats();

// Diary
const diaryDateEl=document.getElementById('diaryDate'),
      diaryMoodEl=document.getElementById('diaryMood'),
      diaryEl=document.getElementById('diary'),
      diaryMsgEl=document.getElementById('diarySavedMsg');
diaryDateEl.valueAsDate=new Date();

document.getElementById('saveDiary').addEventListener('click',()=>{
  const dateVal = diaryDateEl.value || new Date().toISOString().slice(0,10);
  const key='diary:'+ dateVal;
  const entry={
    date: dateVal,
    mood: diaryMoodEl.value,
    note: diaryEl.value,
    savedAt: new Date().toISOString()
  };
  ls.set(key,entry);
  diaryMsgEl.textContent='Saved âœ”';
  setTimeout(()=>diaryMsgEl.textContent='',2000);
  renderDiaryHistory();
});

// Improved Diary History (scrollable journal)
function renderDiaryHistory(){
  const historyEl = document.getElementById('diaryHistory');
  const entries = [];
  
  for(let i=0; i<localStorage.length; i++){
    const k = localStorage.key(i);
    if(k && k.startsWith("diary:")) {
      try { 
        const entry = JSON.parse(localStorage.getItem(k));
        if(entry) entries.push(entry);
      } catch {}
    }
  }
  
  entries.sort((a,b) => new Date(b.date) - new Date(a.date));
  
  if(entries.length === 0){
    historyEl.innerHTML = '<div class="muted">No entries yet.</div>';
    return;
  }
  
  historyEl.innerHTML = entries.map(entry => `
    <div class="diary-entry">
      <div>
        <span class="diary-date">${entry.date || 'Unknown date'}</span>
        <span class="diary-mood">â€” ${entry.mood || 'No mood'}</span>
      </div>
      ${entry.note ? `<div class="diary-note">${escapeHtml(entry.note)}</div>` : '<div class="muted">No notes</div>'}
    </div>
  `).join('');
}

function escapeHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;')
    .replace(/\n/g, '<br/>');
}

renderDiaryHistory();

// Relapse
document.getElementById('relapseBtn').addEventListener('click',()=>{
  if(confirm("Log a relapse? This will reset your streak to 0.")){
    if(streak>longestStreak){ longestStreak=streak; ls.set('longestStreak',streak);}
    streak=0; firstSoberDate=null;
    ls.set('streak',0); ls.set('firstSoberDate',null);
    renderStats();
    alert("Relapse logged. Tomorrow is a new day ðŸŒ±");
  }
});

// Reset
document.getElementById('resetBtn').addEventListener('click',()=>{
  if(confirm("Reset ALL stats (diary will remain)?")){
    streak=0; firstSoberDate=null; longestStreak=0;
    ls.set('streak',0); ls.set('firstSoberDate',null); ls.set('longestStreak',0);
    renderStats();
  }
});

// Motivation
const QUOTES=[
  {q:"One day at a time.",a:"AA Slogan"},
  {q:"Progress, not perfection.",a:"AA Slogan"},
  {q:"You are stronger than your strongest excuse.",a:"Unknown"},
  {q:"The comeback is always stronger than the setback.",a:"Unknown"},
  {q:"Small steps every day lead to big results.",a:"Unknown"}
];
const qi=(new Date().getFullYear()*1000+(new Date().getMonth()+1)*50+new Date().getDate())%QUOTES.length;
document.getElementById('quoteBox').textContent='"'+QUOTES[qi].q+'"';
document.getElementById('quoteAttribution').textContent="â€” "+QUOTES[qi].a;

// Setup Questions
if(baselineSpend === null || baselineSpend === undefined){
  document.getElementById('setupModal').style.display="flex";
}

document.getElementById('saveSetup').addEventListener('click',()=>{
  const spend=parseFloat(document.getElementById('baselineSpend').value||"0");
  if(spend > 0){
    baselineSpend = spend; 
    ls.set('baselineSpend', spend);
    document.getElementById('setupModal').style.display="none";
    renderStats();
  } else {
    alert("Please enter a valid amount (Â£ per week)");
  }
});

document.getElementById('skipSetup').addEventListener('click',()=>{
  baselineSpend = 0; // Set to 0 so modal doesn't show again
  ls.set('baselineSpend', 0);
  document.getElementById('setupModal').style.display="none";
  renderStats();
});

// Change spend functionality
document.getElementById('changeSpendBtn').addEventListener('click',()=>{
  document.getElementById('newBaselineSpend').value = baselineSpend || '';
  document.getElementById('changeSpendModal').style.display="flex";
});

document.getElementById('saveNewSpend').addEventListener('click',()=>{
  const newSpend = parseFloat(document.getElementById('newBaselineSpend').value||"0");
  if(newSpend >= 0){
    baselineSpend = newSpend;
    ls.set('baselineSpend', newSpend);
    document.getElementById('changeSpendModal').style.display="none";
    renderStats();
  } else {
    alert("Please enter a valid amount (Â£ per week, or 0)");
  }
});

document.getElementById('cancelChangeSpend').addEventListener('click',()=>{
  document.getElementById('changeSpendModal').style.display="none";
});

// Reminders (best-effort in-app)
function requestPermissionIfNeeded() {
  if (!('Notification' in window)) return Promise.resolve('unsupported');
  if (Notification.permission === 'granted') return Promise.resolve('granted');
  if (Notification.permission === 'denied') return Promise.resolve('denied');
  return Notification.requestPermission();
}

function fireReminder() {
  const title = 'Daily check-in';
  const body = 'How are you feeling? Log a diary entry or update your progress.';
  if ('Notification' in window && Notification.permission === 'granted') {
    try { new Notification(title, { body, icon: 'icons/icon-192.png' }); }
    catch { alert(body); }
  } else {
    alert(body);
  }
}

function scheduleTick() {
  clearInterval(window.__reminderTimer);
  if (!reminderEnabledEl.checked) {
    reminderStatusEl.textContent = 'Daily reminder is off.';
    return;
  }
  const [hh, mm] = (reminderTimeEl.value || '20:00').split(':').map(n => parseInt(n,10));
  reminderStatusEl.textContent = `Reminder set for ${hh.toString().padStart(2,'0')}:${mm.toString().padStart(2,'0')} daily.`;
  window.__reminderTimer = setInterval(() => {
    const now = new Date();
    if (now.getHours() === hh && now.getMinutes() === mm && now.getSeconds() < 5) {
      const key = 'reminderLast:' + now.toDateString();
      if (ls.get(key, null)) return; // one per day
      ls.set(key, true);
      fireReminder();
    }
  }, 1000);
}

document.getElementById('saveReminder').addEventListener('click', async () => {
  ls.set('reminderEnabled', reminderEnabledEl.checked);
  ls.set('reminderTime', reminderTimeEl.value || '20:00');
  if (reminderEnabledEl.checked) {
    const perm = await requestPermissionIfNeeded();
    if (perm !== 'granted') {
      reminderStatusEl.textContent = 'Notifications not allowed â€” using in-app alerts.';
    }
  }
  scheduleTick();
});
scheduleTick();

// PWA install
let deferredPrompt; const installBtn=document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;installBtn.style.display="inline-block";});
installBtn.addEventListener('click',async()=>{
  if(!deferredPrompt) return alert("Tip: choose 'Install app' from your browser menu");
  deferredPrompt.prompt(); await deferredPrompt.userChoice; installBtn.style.display="none";
});

// Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then((registration) => {
        console.log('SW registered: ', registration);
      })
      .catch((registrationError) => {
        console.log('SW registration failed: ', registrationError);
      });
  });
}
</script>
</body>
</html>