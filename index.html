<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sobriety Tracker</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#4facfe"/>
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    body { font-family: system-ui, sans-serif; margin:0; background:#f2f4f8; color:#1f2937; }
    header { background: linear-gradient(135deg,#4facfe,#00f2fe); color:white; padding:28px 20px; text-align:center; }
    header h1 { margin:0 0 6px; font-size:28px; }
    .container { padding:18px; max-width:980px; margin:0 auto; }
    .cards { display:grid; gap:16px; grid-template-columns:1fr; }
    @media(min-width:700px){.cards{grid-template-columns:repeat(2,1fr);} }
    .card { background:white; border-radius:12px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    .card h3 { margin:0 0 10px; font-size:18px; }
    .stats { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
    .stat { background:#f8fafc; border-radius:10px; padding:12px; text-align:center; }
    .stat .num { font-size:22px; font-weight:700; color:#0f62fe; }
    .btn { padding:10px 14px; border:none; border-radius:8px; cursor:pointer; font-weight:600; color:white; }
    .btn-primary { background:#4facfe; }
    .btn-primary:hover { background:#3a8edb;}
    .btn-danger { background:#ef4444; }
    .btn-danger:hover { background:#dc2626; }
    .muted{color:#6b7280;font-size:13px;}
    textarea,input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;background:#fff;
      color:#000;font-size:16px;line-height:1.4;-webkit-text-fill-color:#000 !important;}
    .quote{background:linear-gradient(135deg,#eef2ff,#ecfeff);border:1px solid #dbeafe;border-radius:10px;padding:12px;}
  </style>
</head>
<body>
  <header>
    <h1>Sobriety Tracker</h1>
    <p>Focus on your streaks and savings ðŸ™Œ</p>
  </header>

  <div class="container">
    <div class="cards">

      <!-- Progress -->
      <div class="card">
        <h3>Progress</h3>
        <div class="stats">
          <div class="stat"><div class="num" id="daysSober">0</div><div class="muted">Days Sober</div></div>
          <div class="stat"><div class="num" id="currentStreak">0</div><div class="muted">Current Streak</div></div>
          <div class="stat"><div class="num" id="longestStreak">0</div><div class="muted">Longest Streak</div></div>
          <div class="stat"><div class="num" id="moneySaved">Â£0</div><div class="muted">Money Saved</div></div>
        </div>
      </div>

      <!-- Daily Diary -->
      <div class="card">
        <h3>Daily Diary</h3>
        <label>Date</label><input id="diaryDate" type="date"/>
        <label>Mood</label>
        <select id="diaryMood"><option>Great</option><option>Good</option><option>Okay</option><option>Meh</option><option>Struggling</option></select>
        <label>Notes</label><textarea id="diary" rows="3"></textarea>
        <button id="saveDiary" class="btn btn-primary" style="margin-top:8px;">Save Entry</button>
        <div class="muted" id="diarySavedMsg"></div>
      </div>

      <!-- Diary History -->
      <div class="card">
        <h3>Diary History</h3>
        <div id="diaryHistory" class="muted">No entries yet.</div>
      </div>

      <!-- Relapse -->
      <div class="card">
        <h3>Relapse</h3>
        <button id="relapseBtn" class="btn btn-danger">Log a Relapse</button>
        <p class="muted">This will reset your streak but keep your diary entries.</p>
      </div>

      <!-- Daily Motivation -->
      <div class="card">
        <h3>Daily Motivation</h3>
        <div class="quote" id="quoteBox">Loading...</div>
        <div class="muted" id="quoteAttribution"></div>
      </div>

      <!-- Settings -->
      <div class="card">
        <h3>Settings</h3>
        <button id="installBtn" class="btn btn-primary" type="button" style="display:none;">ðŸ“² Install App</button>
        <button id="resetBtn" class="btn btn-danger" style="margin-top:8px;">Reset Progress</button>
      </div>
    </div>
  </div>

  <!-- Setup Modal -->
  <div id="setupModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:#000000dd;display:none;align-items:center;justify-content:center;">
    <div style="background:white;padding:20px;border-radius:12px;max-width:400px;width:90%;">
      <h3>Welcome ðŸŽ‰</h3>
      <p>Letâ€™s personalise your journey.</p>
      <label>How much money do you spend per week on alcohol (on average)?</label>
      <input id="baselineSpend" type="number" placeholder="Â£ per week" />
      <button id="saveSetup" class="btn btn-primary" style="margin-top:10px;">Save & Continue</button>
    </div>
  </div>

<script>
const ls = {
  get:(k,d=null)=>{ try{return JSON.parse(localStorage.getItem(k)) ?? d;}catch{return d;} },
  set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),
  del:(k)=>localStorage.removeItem(k)
};

let drinksThisWeek = ls.get('drinksThisWeek',0);
let firstSoberDate = ls.get('firstSoberDate',null);
let streak = ls.get('streak',0);
let longestStreak = ls.get('longestStreak',0);
let baselineSpend = ls.get('baselineSpend', null);

function renderStats(){
  document.getElementById('currentStreak').textContent = streak;
  document.getElementById('daysSober').textContent = calcDaysSober();
  document.getElementById('longestStreak').textContent = longestStreak;
  
  if(baselineSpend){
    const daily = baselineSpend/7;
    const saved = Math.round(daily*calcDaysSober());
    document.getElementById('moneySaved').textContent = "Â£"+saved;
  } else {
    document.getElementById('moneySaved').textContent="Â£0";
  }
}
function calcDaysSober(){
  if(!firstSoberDate) return 0;
  const s=new Date(firstSoberDate), n=new Date();
  return Math.max(0,Math.floor((n-s)/(1000*60*60*24)));
}
// update daily streak
(function daily(){
  const k='lastStreakDay', last=ls.get(k,null), today=new Date().toDateString();
  if(last!==today){
    streak=(streak||0)+1;
    if(!firstSoberDate) firstSoberDate=new Date().toISOString();
    ls.set('firstSoberDate',firstSoberDate);
    ls.set('streak',streak);
    if(streak>longestStreak){ longestStreak=streak; ls.set('longestStreak',streak); }
    ls.set(k,today);
  }
})();
renderStats();

// Diary
const diaryDateEl=document.getElementById('diaryDate'),
      diaryMoodEl=document.getElementById('diaryMood'),
      diaryEl=document.getElementById('diary'),
      diaryMsgEl=document.getElementById('diarySavedMsg');
diaryDateEl.valueAsDate=new Date();
document.getElementById('saveDiary').addEventListener('click',()=>{
  const key='diary:'+ (diaryDateEl.value||new Date().toISOString().slice(0,10));
  const entry={date:diaryDateEl.value,mood:diaryMoodEl.value,note:diaryEl.value,savedAt:new Date().toISOString()};
  ls.set(key,entry);
  diaryMsgEl.textContent='Saved âœ”';
  setTimeout(()=>diaryMsgEl.textContent='',2000);
  renderDiaryHistory();
});
// Diary History
function renderDiaryHistory(){
  const historyEl=document.getElementById('diaryHistory'); const entries=[];
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i);
    if(k.startsWith("diary:")) entries.push(JSON.parse(localStorage.getItem(k)));
  }
  entries.sort((a,b)=> new Date(b.date)-new Date(a.date));
  if(entries.length===0){historyEl.textContent="No entries yet.";return;}
  historyEl.innerHTML=entries.map(e=>`
    <div style="margin-bottom:8px;padding:6px;border-bottom:1px solid #eee;">
      <strong>${e.date}</strong> â€” <em>${e.mood}</em><br>${e.note||""}
    </div>`).join("");
}
renderDiaryHistory();

// Relapse
document.getElementById('relapseBtn').addEventListener('click',()=>{
  if(confirm("Log a relapse? This will reset your streak to 0.")){
    if(streak>longestStreak){ longestStreak=streak; ls.set('longestStreak',streak);}
    streak=0; firstSoberDate=null;
    ls.set('streak',0); ls.set('firstSoberDate',null);
    renderStats();
    alert("Relapse logged. Tomorrow is a new day ðŸŒ±");
  }
});
// Reset
document.getElementById('resetBtn').addEventListener('click',()=>{
  if(confirm("Reset ALL stats (diary will remain)?")){
    streak=0; firstSoberDate=null; longestStreak=0;
    ls.set('streak',0); ls.set('firstSoberDate',null); ls.set('longestStreak',0);
    renderStats();
  }
});

// Motivation
const QUOTES=[{q:"One day at a time.",a:"AA Slogan"},{q:"Progress, not perfection.",a:"AA Slogan"},{q:"You are stronger than your strongest excuse.",a:"Unknown"}];
const qi=(new Date().getFullYear()*1000+(new Date().getMonth()+1)*50+new Date().getDate())%QUOTES.length;
document.getElementById('quoteBox').textContent='"'+QUOTES[qi].q+'"';
document.getElementById('quoteAttribution').textContent="â€” "+QUOTES[qi].a;

// Setup Questions
if(!baselineSpend){
  document.getElementById('setupModal').style.display="flex";
}
document.getElementById('saveSetup').addEventListener('click',()=>{
  const spend=parseFloat(document.getElementById('baselineSpend').value||"0");
  if(spend>0){
    baselineSpend=spend; ls.set('baselineSpend',spend);
    document.getElementById('setupModal').style.display="none";
    renderStats();
  } else {
    alert("Please enter a valid amount (Â£ per week)");
  }
});

// PWA install
let deferredPrompt; const installBtn=document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;installBtn.style.display="inline-block";});
installBtn.addEventListener('click',async()=>{
  deferredPrompt.prompt(); await deferredPrompt.userChoice; installBtn.style.display="none";
});
</script>
</body>
</html>